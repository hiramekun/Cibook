---
title: "ch3_pscore"
author: "hiramekun"
date: "4/29/2021"
output: html_document
---
```{r}
install.packages("WeightIt")
install.packages("MatchIt")
```

```{r}
library("tidyverse")
library("broom")

email_data <- read_csv("http://www.minethatdata.com/Kevin_Hillstrom_MineThatData_E-MailAnalytics_DataMiningChallenge_2008.03.20.csv")
```

```{r}
male_df <- email_data %>%
  filter(segment != "Womens E-Mail") %>% 
  mutate(treatment = ifelse(segment == "Mens E-Mail", 1, 0))
set.seed(1)

obs_rate_c <- 0.5
obs_rate_t <- 0.5

biased_data <- male_df %>%
  mutate(obs_rate_c = ifelse(history > 300 | recency < 6 | channel == "Multichannel", obs_rate_c, 1),
         obs_rate_t = ifelse(history > 300 | recency < 6 | channel == "Multichannel", 1, obs_rate_t),
         random_number = runif(n = NROW(male_df))) %>%
  filter(treatment == 0 & random_number < obs_rate_c | 
           treatment == 1 & random_number < obs_rate_t)

ps_model <- glm(data = biased_data,
                formula = treatment ~ recency + history + channel,
                family = binomial)
ps_model
```

```{r}
library("MatchIt")

m_near <- matchit(formula = treatment ~ recency + history + channel,
                  data = biased_data,
                  method = "nearest",
                  replace = TRUE)
matched_data <- match.data(m_near)
PSM_result <- matched_data %>% lm(formula = spend ~ treatment, data = .) %>% tidy()
```
```{r}
PSM_result
```

```{r}
# (8) 逆確率重み付き推定（IPW）
## ライブラリの読み込み
library("WeightIt")

## 重みの推定
weighting <- weightit(treatment ~ recency + history + channel,
              data = biased_data,
              method = "ps",
              estimand = "ATE")

## 重み付きデータでの効果の推定
IPW_result <- lm(data = biased_data,
                 formula = spend ~ treatment,
                 weights = weighting$weights) %>%
  tidy()
IPW_result
```